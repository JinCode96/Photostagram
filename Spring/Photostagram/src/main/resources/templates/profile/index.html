<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/profileLayout}">
<th:block layout:fragment="main">
        <div id="pro">
          <section>
              <div class="myProfile">
                  <div class="proPhoto">
                      <div>
                      <th:block th:if="${#strings.equals(myName, username)}">
                        <input type="file" class="real-addProf" accept="image/*" style="display: none;"/>
                          <th:block th:if="${not #strings.isEmpty(member.profileImg)}">
                              <img th:src="|@{/}thumb/${member.profileImg}" alt="profile" class="addNewProf" id="profilePhoto"/>
                          </th:block>
                          <th:block th:unless="${not #strings.isEmpty(member.profileImg)}">
                              <img th:src="@{/img/44884218_345707102882519_2446069589734326272_n.jpg}" alt="profile" class="addProf" id="profilePhoto"/>
                          </th:block>
                      </th:block>
                      <th:block th:unless="${#strings.equals(myName, username)}">
                          <th:block th:if="${not #strings.isEmpty(member.profileImg)}">
                              <img th:src="|@{/}thumb/${member.profileImg}" alt="profile" id="profilePhoto" class="notAddProf"/>
                          </th:block>
                          <th:block th:unless="${not #strings.isEmpty(member.profileImg)}">
                              <img th:src="@{/img/44884218_345707102882519_2446069589734326272_n.jpg}" alt="profile" id="profilePhoto" class="notAddProf" />
                          </th:block>
                      </th:block>
                          <span class="profileSpinner"></span>
                      </div>
                  </div>
                  <div class="detail">
                      <div class="pTop">
                          <div class="userName">[[${username}]]</div>
                          <th:block th:if="${#strings.equals(myName, username)}">
                              <a th:href="@{/profile/modify}" class="button">프로필 편집</a>
                          </th:block>
                          <th:block th:unless="${#strings.equals(myName, username)}">
                              <th:block th:if="${result} > 0">
                                  <a href="#" class="button" id="following">팔로잉</a>
                              </th:block>
                              <th:block th:unless="${result} > 0">
                                  <a th:href="@{/profile/follow (type=insert, userName=${username}, myName=${myName})}" class="button" id="follow">팔로우</a>
                              </th:block>
                          </th:block>

                      </div>
                      <ul class="pMiddle">
                          <li>
                              게시물<span>[[${post}]]</span>
                          </li>
                          <th:block th:if="${myFollower == 0}">
                              <li>
                                  <a href="#">팔로워<span>[[${myFollower}]]</span></a>
                              </li>
                          </th:block>
                          <th:block th:unless="${myFollower == 0}">
                              <li>
                                  <a href="#" id="followerModal">팔로워<span>[[${myFollower}]]</span></a>
                              </li>
                          </th:block>
                          <th:block th:if="${myFollowing == 0}">
                              <li>
                                  <a href="#">팔로잉<span>[[${myFollowing}]]</span></a>
                              </li>
                          </th:block>
                          <th:block th:unless="${myFollowing == 0}">
                              <li>
                                  <a href="#" id="followingModal">팔로잉<span>[[${myFollowing}]]</span></a>
                              </li>
                          </th:block>
                      </ul>
                      <p class="pAbout">
                          <span class="notice">
                              [[${member.profileText}]]
                          </span>
                      </p>
                  </div>
              </div>
              <div class="myNav">
                  <div><a href="#">게시물</a></div>
                  <div><a href="#">릴스</a></div>
                  <div><a href="#">태그됨</a></div>
              </div>
              <th:block th:if="${#maps.isEmpty(sortMap)}">
                  <div class="myList">
                    <h1>게시물이 없습니다.</h1>
                  </div>
              </th:block>
              <th:block th:unless="${#maps.isEmpty(sortMap)}">
                  <div class="myList" th:each="m:${sortMap}">
                      <div class="pic">
                          <a th:href="@{/board/post (no=${m.key})}">
                              <img th:src="|@{/}thumb/${m.value}">
                          </a>
                      </div>
                  </div>
              </th:block>
          </section>
            <div id="fCancel" class="fModal">
                <div class="fContents">
                    <span class="fClose">&times;</span>
                    <div id="fTop">
                        <img th:src="@{/img/44884218_345707102882519_2446069589734326272_n.jpg}" alt="profile">
                        <span>[[${username}]]</span>
                    </div>
                    <ul id="fBottom">
                        <li><a href="#" class="fClose"><span>친한 친구 리스트에 추가</span><i class="fa-solid fa-star"></i></a></li>
                        <li><a href="#" class="fClose"><span>즐겨찾기에 추가</span><i class="fa-regular fa-star"></i></a></li>
                        <li><a href="#" class="fClose"><span>일시 차단</span><i class="fa-solid fa-chevron-right"></i></a></li>
                        <li><a href="#" class="fClose"><span>제한</span><i class="fa-solid fa-chevron-right"></i></a></li>
                        <li><a th:href="@{/profile/follow (type=delete, userName=${username}, myName=${myName})}" id="unFollow" class="fClose">팔로우 취소</a></li>
                    </ul>
                </div>
            </div>
            <div id="followerModalWindow" class="fModal">
                <div class="peopleFollow">
                    <div>
                        팔로워
                        <span class="closeFollow">&times;</span>
                    </div>
                    <ul class="fList">
                        <th:block th:each="map:${followerMap}">
                            <th:block th:each="follower,index:${map.key}">
                            <li>
                                <a th:href="@{/profile (username=${follower.username})}">
                                    <div>
                                        <th:block th:if="${not #strings.isEmpty(follower.profileImg)}">
                                            <img th:src="|@{/}thumb/${follower.profileImg}" alt="profile">
                                        </th:block>
                                        <th:block th:unless="${not #strings.isEmpty(follower.profileImg)}">
                                            <img th:src="@{/img/44884218_345707102882519_2446069589734326272_n.jpg}" alt="profile">
                                        </th:block>
                                    </div>
                                    <h1>[[${follower.username}]]</h1>
                                </a>
                                <th:block th:if="${#strings.equals(myName, username)}">
                                    <a href="#" class="aFloatRight userSelect" th:data-value="${follower.username}">
                                        <span>삭제</span>
                                        <span class="spinner"></span>
                                    </a>
                                </th:block>
                                <th:block th:unless="${#strings.equals(myName, username)}">
                                    <th:block th:if="${map.value == 0}">
                                        <a href="#" class="aFloatRight userFollowing" th:data-value="${follower.username}" style="display:none;">
                                            <span>팔로잉</span>
                                            <span class="spinner"></span>
                                        </a>
                                        <a href="#" class="aFloatRight userFollow" th:data-value="${follower.username}">
                                            <!--<img th:src="@{/img/GIF/spinner.gif}" alt="spinner"/>-->
                                            <span>팔로우</span>
                                            <span class="spinner"></span>
                                        </a>
                                    </th:block>
                                    <th:block th:unless="${map.value == 0}">
                                        <a href="#" class="aFloatRight userFollowing" th:data-value="${follower.username}">
                                            <span>팔로잉</span>
                                            <span class="spinner"></span>
                                        </a>
                                        <a href="#" class="aFloatRight userFollow" th:data-value="${follower.username}" style="display:none;">
                                            <!--<img th:src="@{/img/GIF/spinner.gif}" alt="spinner"/>-->
                                            <span>팔로우</span>
                                            <span class="spinner"></span>
                                        </a>
                                    </th:block>
                                </th:block>
                            </li>
                            </th:block>
                        </th:block>
                    </ul>
                </div>
            </div>
            <div id="followingModalWindow" class="fModal">
                <div class="peopleFollow">
                    <div>
                        팔로잉
                        <span class="closeFollowing">&times;</span>
                    </div>
                    <ul class="fList">
                        <th:block th:each="map:${followingMap}">
                            <th:block th:each="following,index:${map.key}">
                                <li>
                                    <a th:href="@{/profile (username=${following.username})}">
                                        <div>
                                            <th:block th:if="${not #strings.isEmpty(following.profileImg)}">
                                                <img th:src="|@{/}thumb/${following.profileImg}" alt="profile">
                                            </th:block>
                                            <th:block th:unless="${not #strings.isEmpty(following.profileImg)}">
                                                <img th:src="@{/img/44884218_345707102882519_2446069589734326272_n.jpg}" alt="profile">
                                            </th:block>
                                        </div>
                                        <h1>[[${following.username}]]</h1>
                                    </a>
                                    <th:block th:if="${#strings.equals(myName, following.username)}">
                                    </th:block>
                                    <th:block th:unless="${#strings.equals(myName, following.username)}">
                                        <th:block th:if="${map.value == 0}">
                                            <a href="#" class="aFloatRight userFollow" th:data-value="${following.username}">
                                                <!--<img th:src="@{/img/GIF/spinner.gif}" alt="spinner"/>-->
                                                <span>팔로우</span>
                                                <span class="spinner"></span>
                                            </a>
                                            <a href="#" class="aFloatRight userFollowing" th:data-value="${following.username}" style="display:none;">
                                                <span>팔로잉</span>
                                                <span class="spinner"></span>
                                            </a>
                                        </th:block>
                                        <th:block th:unless="${map.value == 0}">
                                            <a href="#" class="aFloatRight userFollow" th:data-value="${following.username}" style="display:none;">
                                                <!--<img th:src="@{/img/GIF/spinner.gif}" alt="spinner"/>-->
                                                <span>팔로우</span>
                                                <span class="spinner"></span>
                                            </a>
                                            <a href="#" class="aFloatRight userFollowing" th:data-value="${following.username}">
                                                <span>팔로잉</span>
                                                <span class="spinner"></span>
                                            </a>
                                        </th:block>
                                    </th:block>
                                </li>
                            </th:block>
                        </th:block>
                    </ul>
                </div>
            </div>
            <div id="photoModal" class="photoModal">
                <div class="photoContents">
                    <div id="photoTop">
                        <span>프로필 사진 바꾸기</span>
                    </div>
                    <ul id="photoBottom">
                        <li class="addProf">사진 업로드</li>
                        <li class="deleteProf">현재 사진 삭제</li>
                        <li class="photoClose">취소</li>
                    </ul>
                </div>
            </div>
            <div id="followerDelete" class="secondModalFrame">
                <div class="secondModal">
                    <div>
                        <img th:src="@{/img/44884218_345707102882519_2446069589734326272_n.jpg}">
                        <h1>
                            팔로워를 삭제하시겠어요?<br/>
                            <span id="modalDeleteName">name</span>님은 회원님의 팔로워 리스트에서 삭제된 사실을 알 수 없습니다.</h1>
                    </div>
                    <ul>
                        <li><a href="#" class="pClose followerDelete">삭제</a></li>
                        <li><a href="#" class="pClose">취소</a></li>
                    </ul>
                </div>
            </div>
            <div id="followingCancel" class="cancelModalFrame">
                <div class="cancelModal">
                    <div>
                        <img th:src="@{/img/44884218_345707102882519_2446069589734326272_n.jpg}">
                        <h1><span id="modalCancelName">name</span>님의 팔로우를 취소하시겠어요?</h1>
                    </div>
                    <ul>
                        <li><a href="#" class="pClose followingCancel">팔로우 취소</a></li>
                        <li><a href="#" class="pClose">취소</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </th:block>
</html>
<script>
    $(function(){
      let modal = $('#followingCancel');
      let btn = $('.userFollowing');
      let close = $('.pClose');

      btn.click(function(e){
        modal.show();
        let tag = $(this);
        let userName = tag.attr('data-value');
        let cancelName = $("#modalCancelName");
        cancelName.html(userName);

        $('.followingCancel').click(function(e){
            e.preventDefault();
            tag.children('.spinner').show();
            modal.hide();

            setTimeout(function(){
                $.ajax({
                    url: '/Photostagram/profile/follow',
                    type: 'post',
                    dataType: 'json',
                    data: {'userName':userName, 'type':'delete'},
                    success: function(data){
                        console.log('here1');
                        if(data.result > 0){
                            tag.parent().children('.userFollowing').hide();
                            tag.children('.spinner').hide();
                            tag.parent().children('.userFollow').show();
                        }
                    }
                });
            }, 1000);

        });
      });

      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }

      close.click (function(e){
        modal.hide();
      });

    });
</script>