<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="chatModalFragment">
    <script th:inline="javascript">
        $(function(){
            $('input[name=queryBox]').keydown(function(key) {
                //키의 코드가 13번일 경우 (13번은 엔터키)
                if (key.keyCode == 13) {
                    //경고창을 출력한다.
                    //alert("엔터키를 눌렀습니다.");
                    let keyword = $(this).val();

                    let jsonData = {"keyword":keyword};

                    $.ajax({
                        url:'/Photostagram/findAllUsers',
                        method:'POST',
                        data:jsonData,
                        dataType:'json',
                        success:function(data){
                            let users = data.users;
                            if(users.length == 0){
                                alert('사용자 없음');
                            }else{
                                $('.recommend').hide();
                                users.forEach(function(user){
                                    let member = "<div class='reco-list-main'>";
                                        member += "<div class='reco-list-img'>";
                                        member += "<span class='reco-list-img-1'>";
                                        if(user.profileImg == null){
                                            member += "<img class='reco-list-img-real' src='./img/44884218_345707102882519_2446069589734326272_n.jpg' alt='계정사진'>";
                                        }else{
                                            member += "<img class='reco-list-img-real' src='/Photostagram/thumb/"+user.profileImg+"' alt='계정사진'>";
                                        }
                                        member += "</span>";
                                        member += "</div>";
                                        member += "<div class='reco-id'>";
                                        member += "<div class='reco-id-1'>";
                                        member += "<div class='reco-id-2'>";
                                        member += "<div class='reco-id-3'>"+user.username+"</div>";
                                        member += "</div>";
                                        member += "</div>";
                                        member += "<div class='reco-name'>";
                                        if(user.text != null){
                                            member += "<div class='reco-name-1'>"+user.text+"</div>";
                                        }else{
                                            member += "<div class='reco-name-1'></div>";
                                        }
                                        member += "</div>";
                                        member += "</div>";
                                        member += "<div class='reco-btn' data-username='"+user.username+"' data-no='"+user.no+"'>";
                                        if($('h5').hasClass(user.username)){
                                            member += "<input type='checkbox' name='userCheck' checked>";
                                        }else{
                                            member += "<input type='checkbox' name='userCheck'>";
                                        }
                                        member += "</div>";
                                        member += "</div>";

                                   $('.reco-list-wrap').append(member);
                                });

                                $('input[name=userCheck]').click(function(){

                                    //alert('here1');

                                    let div = $(this).parent('div');
                                    let userCheck  = div.children('input[name=userCheck]');

                                    let length = $('input:checkbox[name=userCheck]:checked').length;
                                    console.log('here1 : '+length);

                                    let username = div.attr('data-username');
                                    let no = div.attr('data-no');

                                    if(userCheck.is(':checked')){
                                        console.log('checked!');
                                        $('.sendingUser').append('<h5 class='+username+' data-num='+no+'>'+username+'&nbsp;&nbsp;</h5>');
                                        $('.new-body2-1').val('');
                                        $('.recommend').show();
                                        $('.reco-list-main').remove();

                                        if($('.sendingUser').children().length > 0){
                                            $('.btn-next').attr("disabled", false);
                                            $('.btn-next').css("color", "#0000ff");
                                        }
                                    }else{
                                        console.log('not checked!');
                                        $('.'+username+'').remove();
                                        $('.new-body2-1').val('');
                                        $('.recommend').show();
                                        $('.reco-list-main').remove();

                                        console.log('h5 length : '+$('h5').length);

                                        if($('.sendingUser').children().length == 0){
                                            $('.btn-next').attr("disabled", true);
                                            $('.btn-next').css("color", "#4db5f9");
                                        }
                                    }

                                });


                            }
                        }
                    });
                }
            });

            $('.btn-next').on('click', function(){
                var checkBoxArr = [];

                $('.sendingUser').children().each(function(){
                    let no = $(this).attr('data-num');
                    checkBoxArr.push(no);
                    console.log(checkBoxArr);
                });
                console.log('checkBoxArr : '+checkBoxArr);

                let my_no = [[${user.no}]];
                console.log('my_no : '+my_no);

                let jsonData = {"user_no":checkBoxArr, "my_no":my_no};
                console.log('jsonData : '+JSON.stringify(jsonData));


                $.ajax({
                    url:'/Photostagram/goChattingRoom',
                    method:'POST',
                    traditional: true,
                    data:jsonData,
                    dataType:'json',
                    success:function(data){
                        let room_no = data.result;
                        console.log('메시지창으로 이동!');
                        location.href='/Photostagram/chat/content?room_no='+room_no;
                    }
                });
            });
        });
    </script>
<!--메시지 보내기 모달-->
<div id="overlay" class="new-wrap">
    <div class="new-content">
        <div class="new-head">
            <div class="new-head-close">
                <img id="confirm" th:src="@{/img/free-icon-close-4013407.png}" alt="닫기">
            </div>
            <div class="new-head-mesg">
                새로운 메시지
            </div>
            <div class="new-head-next">
                <button class="btn-next" disabled="disabled">다음</button>
            </div>
        </div>
        <div class="new-body1">
            <div class="new-body1-1">
                <div class="new-body1-2">
                    <h4 class="new-body1-3">받는 사람: </h4>
                </div>
                <div class="new-body2">
                    <div class="sendingUser"></div>
                    <input class="new-body2-1" autocomplete="off" name="queryBox" placeholder="검색..." spellcheck="false" type="text">
                </div>
            </div>
        </div>
        <div class="new-body3">
            <div class="recommend">
                <div class="recommend-1">추천</div>
            </div>
            <div class="reco-list-wrap" aria-disabled="false" role="button" tabindex="0">
            <!--<div class="reco-list-main">
                    <div class="reco-list-img">
                        <span class="reco-list-img-1">
                          <img class="reco-list-img-real" th:src="@{/img/44884218_345707102882519_2446069589734326272_n.jpg}" alt="계정사진">
                        </span>
                    </div>
                    <div class="reco-id">
                        <div class="reco-id-1">
                            <div class="reco-id-2">
                                <div class="reco-id-3">dlafjd</div>
                            </div>
                        </div>
                        <div class="reco-name">
                            <div class="reco-name-1">
                                아무개</div>
                        </div>
                    </div>
                    <div class="reco-btn">
                        <input type="radio">
                    </div>
                </div>-->
            </div>
        </div>
    </div>
</div>
    <div id="ChatDelete" class="secondModalFrame">
        <div class="secondModal">
            <div>
                <div>
                    <img id="modalDeleteImg" th:src="@{/img/44884218_345707102882519_2446069589734326272_n.jpg}">
                </div>
                <h1>
                    팔로워를 삭제하시겠어요?<br/>
                    <span id="modalDeleteName">name</span>님은 회원님의 팔로워 리스트에서 삭제된 사실을 알 수 없습니다.</h1>
            </div>
            <ul>
                <li><a href="#" class="pClose followerDelete">삭제</a></li>
                <li><a href="#" class="pClose">취소</a></li>
            </ul>
        </div>
    </div>
    <div id="ChatOut" class="cancelModalFrame">
        <div class="cancelModal">
            <div>
                <div>
                    <img id="modalCancelImg" th:src="@{/img/44884218_345707102882519_2446069589734326272_n.jpg}">
                </div>
                <h1>
                    <span id="modalCancelName">name</span>님의 팔로우를 취소하시겠어요?
                </h1>
            </div>
            <ul>
                <li><a href="#" class="pClose followingCancel">팔로우 취소</a></li>
                <li><a href="#" class="pClose">취소</a></li>
            </ul>
        </div>
    </div>
</th:block>
</html>